#!/usr/bin/env bash

from_dir="$(pwd)"
cd "$(dirname "$0")" || exit
PATH="./:$PATH"

# Minimum required Bash version
required_version="5.1"
current_version=$(echo "$BASH_VERSION" | sed -E 's/^([0-9]+\.[0-9]+).*/\1/')

if [[ $(uname) == 'Darwin' ]]; then
    # Check that we have at least Bash 5.1+
    if [[ $(perl -e "print 1 if '$current_version' ge '$required_version'") != 1 ]]; then
        echo "Error: Bash version 5.1+ required. Currently running $current_version."
        echo "To install Bash 5.1+, run the following command:"
        echo "  brew install bash"
        echo "Ensure that Homebrew's bin directory is in your PATH:"
        echo "  export PATH=\"/opt/homebrew/bin:\$PATH\"  # For Apple Silicon (M1+)"
        echo "  export PATH=\"/usr/local/bin:\$PATH\"    # For Intel Macs"
        exit 1
    fi
elif [[ $(uname) == 'Linux' ]]; then
    # Check that we have at least Bash 5.1+
    if [[ $(version_ge "$current_version" "$required_version") != 1 ]]; then
        echo "Error: Bash version 5.1+ required. Currently running $current_version."
        echo "To install Bash 5.1+, run the following command:"
        echo "  sudo apt-get update && sudo apt-get install bash"
        exit 1
    fi
fi

./deps git

version=$(git log -1 --format=%ct)

# Setup environment
touch .etc/barerc && source .etc/barerc
touch .lib/barerc && source .lib/barerc
rsync -a --ignore-existing .lib/.var/ .var

# check if we need to sync bare
touch .var/sync && {
	[[ $(cat .var/sync) -lt $version ]] && {
		bash .lib/sync && echo "$version" > .var/sync
	}
}

[[ $1 == '--version' || $1 == '-v' ]] && echo "$version" && exit 0

[[ $1 == '--upgrade' ]] && git pull origin root

[[ $1 == '--setup' ]] && {
	bash .lib/setup
	exit 0
}

[[ -z $1 ]] && exit 0

# Check if the -I flag is provided for interactive mode

case $1 in

	-[iI]|-[tT]|terminal|--terminal) # i = interactive / t = terminal

		shift && exec bash --rcfile <(cat << EOF

			source ~/.bashrc
			touch .etc/barerc && source .etc/barerc
			touch .lib/barerc && source .lib/barerc

			# put all bare commands in context
			PATH="$(pwd):\$PATH"

			# mostly for Macs running zsh by default
			export BASH_SILENCE_DEPRECATION_WARNING=1

			GREEN='\\033[0;32m'
			YELLOW='\\033[0;33m'
			GRAY='\\033[2;37m'
			RESET='\\033[0m'

			PS1="ðŸ» \[\${GREEN}\]\$(basename \$(pwd)) \[\${YELLOW}\]> \[\${RESET}\]"

			printf "\n\${GRAY}entering bare terminal. type exit when ready to leave.\${RESET}\n"

EOF
		);

		;;

esac

cd "$from_dir" || exit