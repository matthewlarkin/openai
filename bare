#!/usr/bin/env bash

./deps git

# Change directory to the current script's directory
cd "$(dirname "$0")"

# Setup environment
touch ~/.bashrc
[[ -f .etc/barerc ]] && source .etc/barerc
PATH="./:$PATH"

# check if we need to sync bare
touch .var/sync && {
	now=$(git log -1 --format=%ct)
	[[ $(cat .var/sync) -lt $now ]] && {
		bash .lib/sync && echo "$now" > .var/sync
	}
}

# close up shop early, if that's it
[[ -z $1 ]] && exit 0

# Check if the -I flag is provided for interactive mode
if [[ $1 == "-I" || $1 == '-i' ]]; then
    shift
    # Start an interactive bash shell with the current environment
    exec bash --rcfile <(echo "
    source ~/.bashrc
    PATH=\"\$(pwd):\$PATH\"
    export BASH_SILENCE_DEPRECATION_WARNING=1 # mostly for Macs running zsh by default

    GREEN=\"\033[0;32m\"
    YELLOW=\"\033[0;33m\"
    GRAY=\"\033[2;37m\"
    RESET=\"\033[0m\"

    PS1=\"ðŸ» \${GREEN}\$(basename \$(pwd)) \${YELLOW}> \${RESET}\"
    PROMPT_COMMAND=./bare
    printf \"\n\${GRAY}entering bare terminal. type exit when ready to leave.\${RESET}\n\"
    ")
fi

script_name="$1" && shift && ./"$script_name" "$@"

exit 0